# Local testing of distributed mode
# Run: docker-compose up --build

services:
  controller:
    build: .
    command: ["controller", "--listen", "0.0.0.0:9000"]
    ports:
      - "9000:9000"   # Dashboard & API
      - "9001:9001"   # gRPC for workers
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9000/api/stats"]
      interval: 10s
      timeout: 5s
      retries: 3

  worker-1:
    build: .
    command: ["worker", "--connect", "controller:9001"]
    depends_on:
      controller:
        condition: service_healthy

  worker-2:
    build: .
    command: ["worker", "--connect", "controller:9001"]
    depends_on:
      controller:
        condition: service_healthy

  worker-3:
    build: .
    command: ["worker", "--connect", "controller:9001"]
    depends_on:
      controller:
        condition: service_healthy
